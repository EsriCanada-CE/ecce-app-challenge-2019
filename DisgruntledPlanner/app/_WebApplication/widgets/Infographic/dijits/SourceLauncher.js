// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/Evented dojo/on dojo/Deferred dijit/_WidgetBase jimu/utils ../utils jimu/LayerInfos/LayerInfos esri/geometry/geometryEngine esri/tasks/query esri/tasks/QueryTask esri/tasks/StatisticDefinition esri/layers/FeatureLayer ./clientStatistic".split(" "),function(q,d,r,g,m,t,l,h,u,v,w,x,k,y,n){return q([t,r],{oidFieldType:"esriFieldTypeOID",constructor:function(a){this.uniqueID=l.getRandomString();this.map=a.map;this.useSelection=a.useSelection;this.filterByExtent=
a.filterByExtent;this.returnFeatures=a.returnFeatures;this.statistic=a.statistic;this.dataSource=a.dataSource;this.config=a.config;this.isDateType=!!(this.config&&this.config.data||{}).dateConfig;this.layerInfosObj=u.getInstanceSync();this.layerObject=a.layerObject;this.timeIntervalHandle=this.filterChangedHandle=this.updateEndHandle=this.refreshIntervalHandle=this.selectionHandle=this.exchetChangeHandle=this._oldQueryParameter=this._queryParameter=this._layerUrl=null;this._loadingTypes={}},start:function(){this.showLoading("sl-get-lyobj");
this._tryGetLayerObject("sl-get-lyobj").then(function(){this.hideLoading("sl-get-lyobj");this.awake();this._listenEventsContinuousAccessFeatures()}.bind(this),function(a){console.error(a.message||a);this.hideLoading("sl-get-lyobj");this._onFailed()}.bind(this))},awake:function(){this.sleeping=!1;this._getFeaturesForFirst()},sleep:function(){this.sleeping=!0},destroy:function(){this._loadingTypes={};this._removeHandles();this.inherited(arguments)},_getFeaturesForFirst:function(){this._trigerCallback()},
_listenEventsContinuousAccessFeatures:function(){if(this.layerObject&&this.layerInfo){var a=this._shouldAccessClientFeatures();this.useSelection&&(this._resetSelectionHandle(),this.selectionHandle=g(this.layerObject,"selection-complete,selection-clear",d.hitch(this,function(){this._trigerCallback()})));a||(this._resetFilterChangedHandle(),this.filterChangedHandle=g(this.layerInfo,"filterChanged",d.hitch(this,function(a){a&&a.zoomAfterFilter&&this.filterByExtent||this._trigerCallback()})));a&&(this._resetUpdateEndHandle(),
this.updateEndHandle=g(this.layerObject,"update-end",d.hitch(this,function(){this._trigerCallback()})));this.filterByExtent&&this.map&&(this._resetExtentChangeHandle(),this.exchetChangeHandle=g(this.map,"extent-change",d.hitch(this,function(){this.emit("start");this._trigerCallback(!0)})));a||(this._setTimeListener(),this._resetRefreshIntervalHandle(),this.refreshIntervalHandle=g(this.layerObject,"refresh-interval-change",d.hitch(this,this._setTimeListener)))}},_setTimeListener:function(){var a=this._getLayerRefreshInterval();
a?(this._resetTimeIntervalHandle(),this.timeIntervalHandle=setInterval(d.hitch(this,function(){this._trigerCallback()}),6E4*a)):this._resetTimeIntervalHandle()},_trigerCallback:function(a){var b=this.computingTheWayToGetFeatures();if(!a||2!==b||!this._isLayerOnDemandMode())switch(this.emit("start"),b){case 1:this._getFeaturesFromSelection(this.map,this.layerObject,this.filterByExtent,d.hitch(this,this._onDataUpdate));break;case 2:this._getClientFeaturesFromMap(this.map,this.layerObject,this.filterByExtent,
d.hitch(this,this._onDataUpdate));break;case 3:this._getStatisticsFeaturesForServer(d.hitch(this,this._onDataUpdate))}},computingTheWayToGetFeatures:function(){var a=0;return this.sleeping||!this.layerObject?a:a=this._isMapLayer()?this._shouldAccessFeaturesBySelection()?1:this._shouldAccessClientFeatures()?2:3:0},_getClientFeaturesFromMap:function(a,b,c,f){var e=b.graphics;c&&(e=this._filterFeaturesByExtent(a.extent,e));e=this._sortClientFeaturesByObjID(e,b);f(e)},_getFeaturesFromSelection:function(a,
b,c,f){var e=[],d=!1,e=b.getSelectedFeatures(),d=!0;c&&(e=this._filterFeaturesByExtent(a.extent,e));e.isSelectedFeatures=d;e=this._sortClientFeaturesByObjID(e,b);f(e)},_getStatisticsFeaturesForServer:function(a){this._updateLayerInfoFilter();this._tryGenerateQueryParameter();this._shouldLaunchQuery()&&(this.showLoading("sl-sev-st"),this.queryDeferred=this._doQuery(),this.queryDeferred.then(d.hitch(this,function(b){this.queryDeferred=null;this.hideLoading("sl-sev-st");b=b.features||[];b=this._calculateAverageWithNullValueAsZero(b,
this.config);a(b,!0)}),d.hitch(this,function(a){this.queryDeferred=null;console.error(a.message||a);this.hideLoading("sl-sev-st");this._onFailed("sl-sev-st")})))},_updateLayerInfoFilter:function(){if(this.dataSource&&"undefined"!==typeof this.dataSource.layerId){var a=this.layerInfosObj.getLayerInfoById(this.dataSource.layerId);a&&(this._layerFilter=a.getFilter())}},_onFailed:function(){this.emit("failed")},hideLoading:function(a){this._loadingTypes[a]=!1;this._shouldHideLoading()&&this._hideLoading()},
showLoading:function(a){this._loadingTypes[a]=!0;this._showLoading()},_showLoading:function(){this.emit("loading",this.uniqueID)},_hideLoading:function(){this.emit("unloading",this.uniqueID)},_shouldHideLoading:function(){if(this._loadingTypes)return Object.keys(this._loadingTypes).map(function(a){return this._loadingTypes[a]}.bind(this)).every(function(a){return!a})},_onDataUpdate:function(a,b){a=this._getValueByFeatures(a,b);this.emit("data-update",a);setTimeout(function(){this.emit("done")}.bind(this),
500)},_getValueByFeatures:function(a,b){if(!a||!a.length)return null;var c=null;this.returnFeatures?a&&(c={features:a,hasStatisticsed:!!b}):c=this._getValueForNumber(a);return c},_getValueForNumber:function(a){return this._isNeededCalculateForClient()?n.statistic(this.statistic,this.dataSource,a):n.getSingleValueForServerStatFeature(a)},_isMapLayer:function(){return"DATA_SOURCE_FEATURE_LAYER_FROM_MAP"===this.dataSource.dataSourceType},_isLayerOnDemandMode:function(){return this.layerObject&&this.layerObject.currentMode===
y.MODE_ONDEMAND},_shouldAccessFeaturesBySelection:function(){return this.useSelection&&this.layerObject&&this.layerObject.getSelectedFeatures().length},_shouldAccessClientFeatures:function(){var a=this.config&&this.config.data&&"feature"===this.config.data.mode,b=this.isDateType,c=this._isSupportServerStatByExtent();return a||b||!c},_isSupportServerStatByExtent:function(){var a=this.layerObject&&this.layerObject.version&&10.11<=Number(this.layerObject.version),b=this._isLayerSupportStatistics();return a&&
b},_isLayerSupportStatistics:function(){if(this.layerObject&&this.layerObject.url){var a=!1;return a=this.layerObject.advancedQueryCapabilities?!!this.layerObject.advancedQueryCapabilities.supportsStatistics:!!this.layerObject.supportsStatistics}},_getLayerRefreshInterval:function(){if(this.layerObject&&this.layerObject.refreshInterval)return this.layerObject.refreshInterval},_sortClientFeaturesByObjID:function(a,b){if(0<a.length){var c=l.getObjectIdField(b);c&&(b=a[0])&&b.attributes&&b.attributes.hasOwnProperty(c)&&
a.sort(function(a,b){a.attributes||(a.attributes={});b.attributes||(b.attributes={});a=a.attributes[c];b=b.attributes[c];return a<b?-1:a>b?1:0})}return a},_filterFeaturesByExtent:function(a,b){var c=a.normalize();return b=b.filter(d.hitch(this,function(a){try{if(a.geometry){var b="point"===a.geometry.type||"multipoint"===a.geometry;return c.some(d.hitch(this,function(c){return b?c.contains(a.geometry):v.intersects(c,a.geometry)}))}}catch(z){console.error(z)}return!1}))},_calculateAverageWithNullValueAsZero:function(a,
b){if(!this._shouldCalcAvgForNullValue(b)||!a||!a.length)return a;b=b.data&&b.data.valueFields;if(!b||!b.length)return a;var c=b.map(function(a){return a+"_sum"});a.forEach(function(a){var b=a.attributes;if(b){var d=b.STAT_COUNT;"undefined"===typeof d?(d=b.stat_count,delete b.stat_count):delete b.STAT_COUNT;var f,p,g;c.forEach(function(a){g=a.replace(/_SUM$/gi,"");var c=h.upperCaseString(a);a=h.lowerCaseString(a);var e=h.upperCaseString(g+"_AVG");f=b[c];"undefined"===typeof f?(f=b[a],delete b[a]):
delete b[c];!f&&"number"!==typeof f||!d?b[e]=null:(p=f/d,b[e]=p)})}});return a},_shouldCalcAvgForNullValue:function(a){var b=a&&a.data&&a.data.mode,c=a&&a.data&&a.data.operation;a=a&&a.data&&a.data.nullValue;return b&&("category"===b||"field"===b)&&a&&"average"===c},_shouldLaunchQuery:function(){var a=!0,b=!(!this.queryDeferred||this.queryDeferred.isResolved()||this.queryDeferred.isRejected()),c=l.isEqual(this._queryParameter,this._oldQueryParameter);b&&c&&(a=!1);this._oldQueryParameter=d.clone(this._queryParameter);
return a},_getOutStatistics:function(a){var b=a.fields,c=a.type,d=a.nullValue,e=c;d&&"avg"===c&&(e="sum");a=null;b&&b.length?(a=b.map(function(a){var b=h.upperCaseString(a+"_"+e),c=new k;c.statisticType=e;c.onStatisticField=a;c.outStatisticFieldName=b;return c}.bind(this)),d&&"avg"===c&&(b=new k,b.statisticType="count",b.onStatisticField=this._getStatisticsFieldForCountType(this.layerObject),b.outStatisticFieldName="STAT_COUNT",a.push(b))):(b=new k,b.statisticType="count",b.onStatisticField=this._getStatisticsFieldForCountType(this.layerObject),
b.outStatisticFieldName="STAT_COUNT",a=[b]);return a},_tryGenerateQueryParameter:function(){this._queryParameter={};this._layerUrl&&(this._queryParameter.url=this._layerUrl);this._layerFilter&&(this._queryParameter.where=this._layerFilter);var a,b,c;if(this.returnFeatures)this.statistic&&(this._queryParameter.outStatistics=this._getOutStatistics(this.statistic),this.statistic.groupByFields&&(this._queryParameter.groupByFieldsForStatistics=this.statistic.groupByFields));else if(this.statistic){a=this.statistic.type;
b=this.statistic.field;c=h.upperCaseString(b+"_"+a);"count"===this.statistic.type&&(b=this._getStatisticsFieldForCountType(this.layerObject),c="STAT_COUNT");var d=new k;d.statisticType=a;d.onStatisticField=b;d.outStatisticFieldName=c;this._queryParameter.outStatistics=[d]}},_getStatisticsFieldForCountType:function(a){var b=null;a&&(b=(a=(a=a.fields)&&a.filter(function(a){return a.type===this.oidFieldType}.bind(this))[0])&&a.name);return b||"*"},_doQuery:function(){var a=new m;if(!this._queryParameter)return a.reject("Empty query parameter."),
a;if(!this._queryParameter.url)return a.reject("Empty layer url."),a;var b=new x(this._queryParameter.url),c=new w;c.where=this._queryParameter.where||"1\x3d1";c.returnGeometry=!1;this.dataSource.filterByExtent&&this.map&&(c.geometry=this.map.extent);this._queryParameter.groupByFieldsForStatistics&&(c.groupByFieldsForStatistics=this._queryParameter.groupByFieldsForStatistics);if(this._hasVaildOutStatistics(this._queryParameter.outStatistics))c.outStatistics=this._queryParameter.outStatistics;else return a.reject("Invaild outStatistics of query params."),
a;this._queryParameter.orderByFields&&(c.orderByFields=this._queryParameter.orderByFields);return b.execute(c)},_hasVaildOutStatistics:function(a){return a&&a.length?a.every(function(a){return this._isTrueOrZero(a.onStatisticField)&&this._isTrueOrZero(a.outStatisticFieldName)&&!!a.statisticType}.bind(this)):!1},_isTrueOrZero:function(a){return!!a||0===a},_tryGetLayerObject:function(){var a=new m;if("DATA_SOURCE_FEATURE_LAYER_FROM_MAP"!==this.dataSource.dataSourceType)return a.resolve(),a;var b=this.layerInfosObj.getLayerInfoById(this.dataSource.layerId);
if(b)return this.layerInfo=b,this.layerObject?(this._layerUrl=this.layerObject.url,a.resolve(),a):b.getLayerObject().then(d.hitch(this,function(a){this.layerObject=a;this._layerUrl=this.layerObject.url}));a.reject("invaild data source");return a},_isNeededCalculateForClient:function(){var a=this.layerObject&&this.useSelection&&0<this.layerObject.getSelectedFeatures().length,b=this._isSupportServerStatByExtent();return a||!b},_resetExtentChangeHandle:function(){this.exchetChangeHandle&&this.exchetChangeHandle.remove&&
(this.exchetChangeHandle.remove(),this.exchetChangeHandle=null)},_resetUpdateEndHandle:function(){this.updateEndHandle&&this.updateEndHandle.remove&&(this.updateEndHandle.remove(),this.updateEndHandle=null)},_resetFilterChangedHandle:function(){this.filterChangedHandle&&this.filterChangedHandle.remove&&(this.filterChangedHandle.remove(),this.filterChangedHandle=null)},_resetSelectionHandle:function(){this.selectionHandle&&this.selectionHandle.remove&&(this.selectionHandle.remove(),this.selectionHandle=
null)},_resetRefreshIntervalHandle:function(){this.refreshIntervalHandle&&this.refreshIntervalHandle.remove&&(this.refreshIntervalHandle.remove(),this.refreshIntervalHandle=null)},_resetTimeIntervalHandle:function(){this.timeIntervalHandle&&(clearInterval(this.timeIntervalHandle),this.timeIntervalHandle=null)},_removeHandles:function(){this._resetExtentChangeHandle();this._resetUpdateEndHandle();this._resetFilterChangedHandle();this._resetSelectionHandle();this._resetRefreshIntervalHandle();this._resetTimeIntervalHandle();
this._resetSelectionHandle()}})});