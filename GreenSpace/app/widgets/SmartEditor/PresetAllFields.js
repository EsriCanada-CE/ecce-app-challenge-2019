// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/Evented dojo/_base/lang dojo/_base/array dojo/dom-attr dojo/dom-construct dojo/on ./utils ./presetUtils dijit/_TemplatedMixin jimu/BaseWidgetSetting jimu/dijit/Popup".split(" "),function(p,q,h,m,n,k,r,t,l,u,v,w){return p([v,q,u],{baseClass:"jimu-widget-smartEditor-setting-preset",dijitCollection:{},actionsCollection:{},presetFieldInfos:{},_deletedFields:[],postCreate:function(){this.inherited(arguments);this.dijitCollection={};this.actionsCollection={};this.presetFieldInfos=
{};this._deletedFields=[];this.presetContainer=k.create("div",{"class":"esriCTPresetContent"});this._createPresetFieldInfos();this.showingInWidget||this.createContent()},_getRelatedLayersInfo:function(b,c){for(var g=[],d=0;d<b.length;d++){var f={},a;for(a in b[d])if(b[d].hasOwnProperty(a)&&"featureLayer"!==a&&"layerInfo"!==a)if("relationshipInfos"===a)g.push(this._getRelatedLayersInfo(b[d][a],c));else if("fieldValues"===a||"allowUpdateOnly"===a)f[a]=b[d][a];else if("fieldInfos"===a)if(b[d][a].hasOwnProperty("name"))f[a]=
b[d][a];else{var e=this._jimuLayerInfos.getLayerOrTableInfoById(b[d].featureLayer.id),e=t.getConfigInfo(e,{});f[a]=e[a]}f.hasOwnProperty("fieldValues")&&c.push(f)}return g},_getPresetFieldsForLayers:function(b){for(var c=[],g=0;g<b.length;g++){var d=b[g];if(!d.allowUpdateOnly&&d.fieldValues){for(var f in d.fieldValues)for(var a=0;a<d.fieldValues[f].length;a++){var e=d.fieldValues[f][a];"Preset"===e.actionName&&e.enabled&&(this.actionsCollection[f]||(this.actionsCollection[f]=[]),this.actionsCollection[f].push(e),
c.push(f))}if(0<c.length)for(a=0;a<c.length;a++){var e=c[a],h=l.getFieldInfoByFieldName(d.fieldInfos,e);this.presetFieldInfos.hasOwnProperty(e)?this.presetFieldInfos[e]=l.changeFieldToMostRestrictive(this.presetFieldInfos[e],h):this.presetFieldInfos[e]=h}}}return c},_createPresetFieldInfos:function(){this.presetFieldInfos={};m.forEach(this.configInfos,h.hitch(this,function(b){var c=[];b.relationshipInfos&&this._getRelatedLayersInfo(b.relationshipInfos,c);this._getPresetFieldsForLayers([b]);0<c.length&&
this._getPresetFieldsForLayers(c)}))},_disableActionsForDeletedFields:function(){m.forEach(this._deletedFields,h.hitch(this,function(b){for(var c=0;c<this.actionsCollection[b].length;c++)h.mixin(this.actionsCollection[b][c],{enabled:!1})}))},_deleteField:function(b){var c;c=n.get(b.currentTarget,"fieldName");this._deletedFields.push(c);k.destroy(b.currentTarget.parentElement);delete this.dijitCollection[c]},createContent:function(){k.create("div",{innerHTML:this.nls.presetAll.hintMsg,"class":"esriCTPresetHint"},
this.presetContainer);for(var b in this.presetFieldInfos){var c=this.presetFieldInfos[b],g=k.create("div",{},this.presetContainer);k.create("div",{innerHTML:c.label,"class":"esriCTFieldTitle"},g);var d=k.create("div",{"class":"esriCTDeletePreset close-btn jimu-icon jimu-icon-close",title:this.nls.presetAll.deleteTitle},g);n.set(d,"fieldName",b);this.own(r(d,"click",h.hitch(this,this._deleteField)));c=l.createPresetFieldContentNode(c);this.dijitCollection[b]=c;for(d=0;d<c.length;d++){var f=c[d],a,
e=k.create("div",{"class":"fieldContentNode"});f.placeAt(e);g.appendChild(e);this._configuredPresetInfos&&this._configuredPresetInfos[b]&&(a=this._configuredPresetInfos[b]);if(a&&0<a.length){e=a[0];if("dijit.form.DateTextBox"===f.declaredClass||"dijit.form.TimeTextBox"===f.declaredClass)e=""===e||null===e?null:new Date(e);f.set("value",e)}}}this.showDialog()},showDialog:function(){var b=new w({titleLabel:this.nls.presetAll.popupTitle,width:400,maxHeight:600,autoHeight:!0,content:this.presetContainer,
"class":this.baseClass,buttons:[{label:this.nls.ok,onClick:h.hitch(this,function(){this._savePresetValues()&&(this._deletedFields&&0<this._deletedFields.length&&this._disableActionsForDeletedFields(),this.emit("PrestInfoUpdated",this._configuredPresetInfos),b.close())})},{label:this.nls.cancel,classNames:["jimu-btn-vacation"],onClick:h.hitch(this,function(){b.close()})}],onClose:h.hitch(this,function(){})})},_savePresetValues:function(){var b=!0,c={},g;for(g in this.dijitCollection){var d=[],f=this.dijitCollection[g];
if(!l.isValidPresetValue(f)){b=!1;break}var a=this.presetFieldInfos[g];if("esriFieldTypeDate"===a.type)for(var a=l.getDateFieldValue(a,f),e=0;e<f.length;e++)d.push(a);else for(e=0;e<f.length;e++){var h=f[e].get("value");-1!==l.integerFields.indexOf(a.type)?isNaN(h)?d.push(""):d.push(h):d.push(h)}c[g]=d}b&&(this._configuredPresetInfos=c);return b}})});